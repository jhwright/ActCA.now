---
// --- IMPORTS ---
import '../styles/global.css';
import { getCollection } from 'astro:content';

// --- PROPS ---
interface Props {
  title?: string;
  description?: string;
}

const { 
  title = "A Call a Day Keeps the Fascists Away!",
  description = "A Call a Day Keeps the Fascists Away!"
} = Astro.props;

// Get unique states for the filter dropdown (only on pages that need it)
let uniqueStates: string[] = [];
try {
  const allCalls = await getCollection('calls');
  uniqueStates = Array.from(new Set(allCalls.map(call => call.data.state))).sort();
} catch (e) {
  // If collection doesn't exist or isn't available, use empty array
  uniqueStates = [];
}
---

<!doctype html>
<html lang="en" class="bg-slate-900">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="color-scheme" content="dark" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <!-- OpenGraph Tags for Richmond-specific social sharing -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://actup.now" />
    <meta property="og:image" content="https://actup.now/og-image.jpg" />
    <meta property="og:locale" content="en_US" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    
    <title>{title}</title>
  </head>
  <body class="bg-slate-900 text-slate-100">
    <!-- Flowbite Navbar -->
    <nav class="bg-slate-900 fixed w-full z-20 top-0 start-0 border-b border-yellow-400">
      <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
        <a href="/" class="flex items-center space-x-3 rtl:space-x-reverse">
          <span class="self-center text-sm sm:text-lg md:text-xl lg:text-2xl font-bold text-yellow-400 break-words sm:whitespace-nowrap">
            A Call a Day Keeps the Fascists Away!
          </span>
        </a>
        <button 
          data-collapse-toggle="navbar-default" 
          type="button" 
          class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-yellow-400 rounded-lg md:hidden hover:bg-slate-800 hover:text-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-400" 
          aria-controls="navbar-default" 
          aria-expanded="false"
        >
          <span class="sr-only">Open main menu</span>
          <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M5 7h14M5 12h14M5 17h14"/>
          </svg>
        </button>
        <div class="hidden w-full md:flex md:w-auto md:items-center" id="navbar-default">
          <ul class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-yellow-400 rounded-lg bg-slate-800 md:flex-row md:space-x-4 rtl:space-x-reverse md:mt-0 md:border-0 md:bg-transparent md:items-center">
            <li>
              <a 
                href="/suggestions"
                class="block py-2 px-3 text-yellow-400 rounded hover:bg-slate-800 md:hover:bg-transparent md:border-0 md:hover:text-yellow-300 md:p-0"
              >
                ðŸ’¡ Suggestions
              </a>
            </li>
            {uniqueStates.length > 0 && (
              <li class="flex items-center gap-2">
                <select
                  id="state-filter"
                  class="px-2 py-1 text-sm text-yellow-400 bg-slate-800 border border-yellow-400 rounded hover:bg-slate-700 focus:outline-none focus:ring-1 focus:ring-yellow-400 cursor-pointer"
                  aria-label="Filter calls by state"
                >
                  <option value="ALL">USA</option>
                  {uniqueStates.map((state) => (
                    <option value={state}>{state}</option>
                  ))}
                </select>
                <button
                  id="use-location-btn"
                  type="button"
                  class="p-1.5 text-yellow-400 bg-slate-800 border border-yellow-400 rounded hover:bg-slate-700 focus:outline-none focus:ring-1 focus:ring-yellow-400 transition-colors"
                  aria-label="Use my location to filter calls"
                  title="Use my location"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </button>
              </li>
            )}
          </ul>
        </div>
      </div>
    </nav>
    
    <!-- Main content with top padding to account for fixed header -->
    <div class="pt-20">
      <slot />
    </div>
    
    <script is:inline>
      // Ensure mobile menu toggle works reliably
      (() => {
        const initMenuToggle = () => {
          const menuButton = document.querySelector('[data-collapse-toggle="navbar-default"]');
          const menu = document.getElementById('navbar-default');
          
          if (!menuButton || !menu) return;
          
          // Add reliable manual toggle
          menuButton.addEventListener('click', (e) => {
            e.preventDefault();
            const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';
            const newExpanded = !isExpanded;
            menuButton.setAttribute('aria-expanded', newExpanded);
            menu.classList.toggle('hidden');
          });
        };
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initMenuToggle);
        } else {
          initMenuToggle();
        }
      })();
      
      // Initialize Flowbite for other components
      import('flowbite').then(({ initFlowbite }) => {
        initFlowbite();
      });
    </script>
    
    {uniqueStates.length > 0 && (
      <script is:inline define:vars={{ uniqueStates }}>
        // Geolocation functionality for location button
        (() => {
          const USE_LOCATION_BTN_ID = 'use-location-btn';
          const STATE_FILTER_ID = 'state-filter';
          const STORAGE_KEY = 'actup:state';
          
          const useLocationBtn = document.getElementById(USE_LOCATION_BTN_ID);
          const stateFilter = document.getElementById(STATE_FILTER_ID);
          
          if (!useLocationBtn || !stateFilter) return;
          
          // Reverse geocode coordinates to state using Nominatim (OpenStreetMap)
          const reverseGeocode = async (lat, lon) => {
            try {
              const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`,
                {
                  headers: {
                    'User-Agent': 'ActCA.now/1.0'
                  }
                }
              );

              if (!response.ok) {
                throw new Error(`Geocoding failed: ${response.status}`);
              }

              const data = await response.json();
              const address = data.address;
              
              const stateCode = address?.state_code || address?.ISO3166_2_lvl4?.split('-')[1];
              
              if (stateCode && stateCode.length === 2) {
                return stateCode.toUpperCase();
              }
              
              const stateName = address?.state;
              if (stateName) {
                const stateMap = {
                  'california': 'CA',
                  'new york': 'NY',
                  'texas': 'TX',
                  'florida': 'FL',
                  'illinois': 'IL',
                  'pennsylvania': 'PA',
                  'ohio': 'OH',
                  'georgia': 'GA',
                  'north carolina': 'NC',
                  'michigan': 'MI'
                };
                const normalized = stateName.toLowerCase();
                return stateMap[normalized] || null;
              }

              return null;
            } catch (error) {
              console.error('Reverse geocoding error:', error);
              return null;
            }
          };

          // Use browser geolocation to detect user's state
          const detectUserLocation = async () => {
            if (!navigator.geolocation) {
              alert('Geolocation is not supported by your browser.');
              return null;
            }

            return new Promise((resolve) => {
              const originalHTML = useLocationBtn.innerHTML;
              useLocationBtn.disabled = true;
              useLocationBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';

              navigator.geolocation.getCurrentPosition(
                async (position) => {
                  const { latitude, longitude } = position.coords;
                  
                  const stateCode = await reverseGeocode(latitude, longitude);
                  
                  useLocationBtn.disabled = false;
                  useLocationBtn.innerHTML = originalHTML;
                  
                  if (stateCode) {
                    resolve(stateCode);
                  } else {
                    alert('Unable to determine your state. Please select manually from the dropdown.');
                    resolve(null);
                  }
                },
                (error) => {
                  useLocationBtn.disabled = false;
                  useLocationBtn.innerHTML = originalHTML;
                  
                  if (error.code === error.PERMISSION_DENIED) {
                    alert('Location access denied. Please select your state manually from the dropdown.');
                  } else {
                    alert('Unable to get your location. Please select your state manually from the dropdown.');
                  }
                  resolve(null);
                },
                {
                  timeout: 10000,
                  enableHighAccuracy: false
                }
              );
            });
          };

          // Handle use location button click
          useLocationBtn.addEventListener('click', async () => {
            const stateCode = await detectUserLocation();
            if (stateCode) {
              const option = Array.from(stateFilter.options).find(opt => opt.value === stateCode);
              if (option) {
                stateFilter.value = stateCode;
                stateFilter.dispatchEvent(new Event('change'));
                
                // Save to localStorage
                try {
                  localStorage.setItem(STORAGE_KEY, stateCode);
                } catch (e) {}
                
                // Update URL
                const url = new URL(window.location);
                url.searchParams.set('state', stateCode);
                window.history.replaceState({}, '', url);
              } else {
                alert(`State ${stateCode} is not available in the current calls. Showing all states.`);
              }
            }
          });
        })();
      </script>
    )}
  </body>
</html>

