---
// --- IMPORTS ---
import type { CollectionEntry } from 'astro:content';

// --- PROPS ---
interface Props {
  call: CollectionEntry<'calls'>;
  targetID: string;
}

const { call, targetID } = Astro.props;
const { data } = call;

// Format phone number as (xxx) xxx-xxxx
function formatPhoneNumber(phone: string): string {
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
  }
  return phone; // Return original if not 10 digits
}

const formattedPhone = formatPhoneNumber(data.phone);
---

<div 
  class="bg-slate-900 rounded-lg border border-slate-800 mb-4 flex flex-col"
  style="max-height: calc(100vh - 8rem);"
  data-call-card
  data-target-id={targetID}
>
  <!-- Fixed Header Section -->
  <div class="p-6 pb-4 flex-shrink-0">
    <!-- Priority Flag -->
    {data.priority && (
      <div class="mb-3">
        <span class="inline-block px-3 py-1 bg-yellow-400 text-slate-950 text-sm font-bold rounded">
          URGENT
        </span>
      </div>
    )}
    
    <!-- Official Info -->
    <div class="mb-4">
      <h3 class="text-xl font-bold text-yellow-400 mb-1">{data.officialName}, {data.officialTitle}</h3>
    </div>
  </div>
  
  <!-- Scrollable Content Area -->
  <div class="flex-1 overflow-y-auto px-6 pb-4" data-call-scroll>
    <!-- Script (sticky so it stays visible while you scroll on mobile) -->
    <div class="call-script-sticky mb-4">
      <p class="text-white text-lg font-semibold leading-relaxed">{data.script}</p>
    </div>
    
    <!-- No-JS rationale toggle -->
    <details class="mb-4 bg-slate-800 rounded-lg border-2 border-slate-700">
      <summary class="min-h-[48px] px-4 text-yellow-400 font-semibold text-base flex items-center justify-center hover:bg-slate-700 transition-colors cursor-pointer select-none">
        ‚ÑπÔ∏è Rationale
      </summary>
      <div class="p-4 border-t border-slate-700">
        <p class="text-slate-300 text-sm leading-relaxed">{data.rationale}</p>
      </div>
    </details>
  </div>
  
  <!-- Fixed Bottom Button -->
  <div class="p-6 pt-4 flex-shrink-0">
    <!-- Tap to Call Button - Styled like opening page buttons -->
    <a
      href={`tel:${data.phone}`}
      class="call-cta js-call-cta w-full min-h-[64px] font-extrabold text-2xl rounded-2xl flex items-center justify-center text-center transition-all duration-200 active:scale-[0.98] cursor-pointer px-5 py-3 focus-visible:outline-none"
      aria-label={`Call ${data.officialName} at ${formattedPhone}`}
    >
      <span class="flex items-center gap-3">
        <span aria-hidden="true">üìû</span>
        <span class="uppercase tracking-wide">Tap to call</span>
        <span class="opacity-90 font-black">{formattedPhone}</span>
      </span>
    </a>
  </div>
</div>

<script is:inline>
  // Persist scroll position so when you return from the phone dialer on mobile,
  // the script stays put instead of jumping back to the top.
  // Also track phone number clicks.
  (() => {
    console.log('CallCard script: Starting initialization...');
    
    // Wait for DOM to be ready
    const init = () => {
      const card = document.querySelector('[data-call-card]');
      console.log('CallCard script: Card element found:', !!card);
      if (!card) {
        console.warn('CallCard script: [data-call-card] not found');
        return;
      }

      const scrollEl = card.querySelector('[data-call-scroll]');
      const callLink = card.querySelector('.js-call-cta');
      const targetID = card.getAttribute('data-target-id') || 'unknown';
      
      console.log('CallCard script: Elements found:', {
        scrollEl: !!scrollEl,
        callLink: !!callLink,
        targetID: targetID
      });
      
      if (!scrollEl || !callLink) {
        console.warn('CallCard script: Missing required elements (scrollEl or callLink)');
        return;
      }

    const key = `actca:callScroll:${targetID}`;

    const save = () => {
      try {
        localStorage.setItem(key, String(scrollEl.scrollTop || 0));
      } catch {}
    };

    const restore = () => {
      try {
        const raw = localStorage.getItem(key);
        if (raw == null) return;
        const y = Number(raw);
        if (!Number.isFinite(y)) return;
        scrollEl.scrollTop = y;
      } catch {}
    };

    // Track phone number clicks
    const trackPhoneClick = (e) => {
      // Extract phone number from href (tel:XXXXXXXXXX)
      const phone = callLink.getAttribute('href')?.replace('tel:', '') || '';
      
      // Prepare tracking data
      const trackingData = {
        phone: phone,
        targetID: targetID,
        eventType: 'click',
        zip: null // Can be enhanced later if zip is available
      };

      console.log('Tracking phone click:', trackingData);

      const data = JSON.stringify(trackingData);
      const endpoint = '/.netlify/functions/log-call';

      // Use fetch with keepalive for reliable delivery (works better than sendBeacon for JSON)
      fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: data,
        keepalive: true // Ensures request completes even if page unloads
      })
        .then(response => {
          if (!response.ok) {
            console.error('Click tracking failed:', response.status, response.statusText);
          } else {
            return response.json().then(result => {
              console.log('Click tracked successfully:', result);
            });
          }
        })
        .catch(error => {
          console.error('Error tracking click:', error);
          // Silently fail - don't block navigation
        });
    };

    callLink.addEventListener('click', (e) => {
      save();
      trackPhoneClick(e);
    }, { passive: true });
    
    window.addEventListener('pagehide', save, { passive: true });
    window.addEventListener('pageshow', restore, { passive: true });
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') restore();
    });

    // Initial load
    restore();
    
    console.log('CallCard script: Event listeners attached successfully');
    };

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      // DOM already ready
      init();
    }
  })();
</script>

