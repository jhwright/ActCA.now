---
// --- IMPORTS ---
import type { CollectionEntry } from 'astro:content';

// --- PROPS ---
interface Props {
  call: CollectionEntry<'calls'>;
  targetID: string;
}

const { call, targetID } = Astro.props;
const { data } = call;

// Format phone number as (xxx) xxx-xxxx
function formatPhoneNumber(phone: string): string {
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
  }
  return phone; // Return original if not 10 digits
}

const formattedPhone = formatPhoneNumber(data.phone);
---

<div 
  class="bg-slate-900 rounded-lg border border-slate-800 mb-4 flex flex-col"
  style="max-height: calc(100vh - 8rem);"
  data-call-card
  data-target-id={targetID}
>
  <!-- Fixed Header Section -->
  <div class="p-6 pb-4 flex-shrink-0">
    <!-- Priority Flag -->
    {data.priority && (
      <div class="mb-3">
        <span class="inline-block px-3 py-1 bg-yellow-400 text-slate-950 text-sm font-bold rounded">
          URGENT
        </span>
      </div>
    )}
    
    <!-- Official Info -->
    <div class="mb-4">
      <h3 class="text-xl font-bold text-yellow-400 mb-1">{data.officialName}, {data.officialTitle}</h3>
    </div>
  </div>
  
  <!-- Scrollable Content Area -->
  <div class="flex-1 overflow-y-auto px-6 pb-4" data-call-scroll>
    <!-- Script (sticky so it stays visible while you scroll on mobile) -->
    <div class="call-script-sticky mb-4">
      <p class="text-white text-lg font-semibold leading-relaxed" data-call-script>{data.script}</p>
    </div>
    
    <!-- No-JS rationale toggle -->
    <details class="mb-4 bg-slate-800 rounded-lg border-2 border-slate-700">
      <summary class="min-h-[48px] px-4 text-yellow-400 font-semibold text-base flex items-center justify-center hover:bg-slate-700 transition-colors cursor-pointer select-none">
        ‚ÑπÔ∏è Rationale
      </summary>
      <div class="p-4 border-t border-slate-700">
        <p class="text-slate-300 text-sm leading-relaxed">{data.rationale}</p>
      </div>
    </details>
  </div>
  
  <!-- Fixed Bottom Button -->
  <div class="p-6 pt-4 flex-shrink-0">
    <!-- Tap to Call Button - Styled like opening page buttons -->
    <a
      href={`tel:${data.phone}`}
      class="call-cta js-call-cta w-full min-h-[64px] font-extrabold text-2xl rounded-2xl flex items-center justify-center text-center transition-all duration-200 active:scale-[0.98] cursor-pointer px-5 py-3 focus-visible:outline-none"
      aria-label={`Call ${data.officialName} at ${formattedPhone}`}
    >
      <span class="flex items-center gap-3">
        <span aria-hidden="true">üìû</span>
        <span class="uppercase tracking-wide">Tap to call</span>
        <span class="opacity-90 font-black">{formattedPhone}</span>
      </span>
    </a>
  </div>
</div>

<script is:inline>
  // Persist scroll position so when you return from the phone dialer on mobile,
  // the script stays put instead of jumping back to the top.
  // Also track phone number clicks.
  (() => {
    console.log('CallCard script: Starting initialization...');
    
    // Wait for DOM to be ready
    const init = () => {
      const card = document.querySelector('[data-call-card]');
      console.log('CallCard script: Card element found:', !!card);
      if (!card) {
        console.warn('CallCard script: [data-call-card] not found');
        return;
      }

      const scrollEl = card.querySelector('[data-call-scroll]');
      const callLink = card.querySelector('.js-call-cta');
      const scriptEl = card.querySelector('[data-call-script]');
      const targetID = card.getAttribute('data-target-id') || 'unknown';
      
      console.log('CallCard script: Elements found:', {
        scrollEl: !!scrollEl,
        callLink: !!callLink,
        scriptEl: !!scriptEl,
        targetID: targetID
      });
      
      if (!scrollEl || !callLink) {
        console.warn('CallCard script: Missing required elements (scrollEl or callLink)');
        return;
      }

    const key = `actca:callScroll:${targetID}`;
    const zipKey = 'actca:zip';

    const save = () => {
      try {
        localStorage.setItem(key, String(scrollEl.scrollTop || 0));
      } catch {}
    };

    const restore = () => {
      try {
        const raw = localStorage.getItem(key);
        if (raw == null) return;
        const y = Number(raw);
        if (!Number.isFinite(y)) return;
        scrollEl.scrollTop = y;
      } catch {}
    };

    const normalizeZip = (input) => {
      if (typeof input !== 'string') return null;
      const trimmed = input.trim();
      if (!trimmed) return null;
      const digits = trimmed.replace(/\D/g, '');
      if (digits.length === 5) return digits;
      if (digits.length === 9) return `${digits.slice(0, 5)}-${digits.slice(5)}`;
      return null;
    };

    const getStoredZip = () => {
      try {
        const raw = localStorage.getItem(zipKey);
        return normalizeZip(raw);
      } catch {
        return null;
      }
    };

    const setStoredZip = (zip) => {
      try {
        if (!zip) return;
        localStorage.setItem(zipKey, zip);
      } catch {}
    };

    const applyZipToScript = (zip) => {
      if (!scriptEl) return;
      if (!zip) return;
      try {
        const current = scriptEl.textContent || '';
        // Replace common placeholder patterns.
        const updated = current.replace(/\[ZIP\]/g, zip).replace(/\{\{ZIP\}\}/g, zip);
        if (updated !== current) scriptEl.textContent = updated;
      } catch {}
    };

    const promptForZipIfMissing = () => {
      const existing = getStoredZip();
      if (existing) return existing;

      // In some environments (automated browsers, hardened privacy settings),
      // prompt/alert may be blocked or unsupported. In that case, just proceed.
      if (typeof window.prompt !== 'function') return null;

      // Optional, but asked at click-time for user intent/accuracy.
      // Allow cancel/blank to proceed without a ZIP.
      let zip = null;
      for (let attempt = 0; attempt < 2; attempt++) {
        let input = null;
        try {
          input = window.prompt('Enter your ZIP code (optional):', '');
        } catch {
          return null;
        }
        if (input == null) return null; // user cancelled
        const normalized = normalizeZip(input);
        if (!input.trim()) return null; // blank = skip
        if (normalized) {
          zip = normalized;
          break;
        }
        try {
          window.alert('Please enter a valid 5-digit ZIP code (or ZIP+4), or leave blank.');
        } catch {
          return null;
        }
      }

      if (zip) setStoredZip(zip);
      return zip;
    };

    // If we already have a ZIP, immediately personalize the script text.
    applyZipToScript(getStoredZip());

    // Track phone number clicks
    const trackPhoneClick = (zip) => {
      // Extract phone number from href (tel:XXXXXXXXXX)
      const phone = callLink.getAttribute('href')?.replace('tel:', '') || '';
      
      // Prepare tracking data
      const trackingData = {
        phone: phone,
        targetID: targetID,
        eventType: 'click',
        zip: zip || null
      };

      console.log('Tracking phone click:', trackingData);

      const data = JSON.stringify(trackingData);
      const endpoint = '/.netlify/functions/log-call';

      // Use fetch with keepalive for reliable delivery (works better than sendBeacon for JSON)
      fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: data,
        keepalive: true // Ensures request completes even if page unloads
      })
        .then(response => {
          if (!response.ok) {
            console.error('Click tracking failed:', response.status, response.statusText);
          } else {
            return response.json().then(result => {
              console.log('Click tracked successfully:', result);
            });
          }
        })
        .catch(error => {
          console.error('Error tracking click:', error);
          // Silently fail - don't block navigation
        });
    };

    callLink.addEventListener('click', (e) => {
      save();
      const existingZip = getStoredZip();
      if (existingZip) {
        applyZipToScript(existingZip);
        trackPhoneClick(existingZip);
        return; // let default navigation to tel: happen
      }

      // Need to ask for ZIP; prevent navigation until prompt completes.
      e.preventDefault();
      const href = callLink.getAttribute('href');
      let zip = null;
      try {
        zip = promptForZipIfMissing();
        if (zip) applyZipToScript(zip);
      } catch (err) {
        console.warn('ZIP prompt failed; continuing without ZIP.', err);
      }
      trackPhoneClick(zip);

      // Continue to dialer even if prompting/tracking fails.
      if (href) window.location.href = href;
    }, { passive: false });
    
    window.addEventListener('pagehide', save, { passive: true });
    window.addEventListener('pageshow', restore, { passive: true });
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') restore();
    });

    // Initial load
    restore();
    
    console.log('CallCard script: Event listeners attached successfully');
    };

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      // DOM already ready
      init();
    }
  })();
</script>

