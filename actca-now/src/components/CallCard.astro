---
// --- IMPORTS ---
import type { CollectionEntry } from 'astro:content';

// --- PROPS ---
interface Props {
  call: CollectionEntry<'calls'>;
  targetID: string;
}

const { call, targetID } = Astro.props;
const { data } = call;
const photoPath = `/officials/${call.id}.jpg`;

// Format phone number as (xxx) xxx-xxxx
function formatPhoneNumber(phone: string): string {
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
  }
  return phone; // Return original if not 10 digits
}

const formattedPhone = formatPhoneNumber(data.phone);
---

<div 
  x-data="{ showRationale: false }"
  class="bg-slate-900 rounded-lg border border-slate-800 mb-4 flex flex-col"
  style="max-height: calc(100vh - 8rem);"
>
  <!-- Fixed Header Section -->
  <div class="p-6 pb-4 flex-shrink-0">
    <!-- Priority Flag -->
    {data.priority && (
      <div class="mb-3">
        <span class="inline-block px-3 py-1 bg-yellow-400 text-slate-950 text-sm font-bold rounded">
          URGENT
        </span>
      </div>
    )}
    
    <!-- Official Photo and Info -->
    <div class="flex items-start gap-4 mb-4">
      <img 
        src={photoPath} 
        alt={`${data.officialName}`}
        class="w-20 h-20 rounded-full object-cover border-2 border-yellow-400"
        onerror={`this.style.display = 'none';`}
      />
      <div class="flex-1">
        <h3 class="text-xl font-bold text-yellow-400 mb-1">{data.officialName}, {data.officialTitle}</h3>
      </div>
    </div>
  </div>
  
  <!-- Scrollable Content Area -->
  <div class="flex-1 overflow-y-auto px-6 pb-4">
    <!-- Script -->
    <div class="mb-4">
      <p class="text-white text-lg font-semibold leading-relaxed">{data.script}</p>
    </div>
    
    <!-- Rationale - Hidden by default, shown when button clicked -->
    <div 
      x-show="showRationale"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 transform -translate-y-2"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 transform translate-y-0"
      x-transition:leave-end="opacity-0 transform -translate-y-2"
      class="mb-4 p-4 bg-slate-800 rounded-lg border border-slate-700"
    >
      <p class="text-slate-300 text-sm leading-relaxed">{data.rationale}</p>
    </div>
    
    <!-- Rationale Button -->
    <button
      @click="showRationale = !showRationale"
      class="w-full mb-4 min-h-[48px] bg-slate-800 text-yellow-400 font-semibold text-base rounded-lg flex items-center justify-center hover:bg-slate-700 transition-colors border-2 border-slate-700 hover:border-yellow-400/50"
    >
      <span x-show="!showRationale">‚ÑπÔ∏è Show Rationale</span>
      <span x-show="showRationale">‚ÑπÔ∏è Hide Rationale</span>
    </button>
  </div>
  
  <!-- Fixed Bottom Button -->
  <div class="p-6 pt-4 flex-shrink-0">
    <!-- Tap to Call Button - Styled like opening page buttons -->
    <a
      href={`tel:${data.phone}`}
      class="w-full min-h-[50px] font-bold text-xl rounded-2xl flex items-center justify-center text-center transition-all duration-200 border-2 active:scale-[0.98] shadow-lg hover:shadow-xl cursor-pointer"
      style={`background-color: #facc15; color: #0f172a; border-color: #eab308; padding-left: 1.0rem; padding-right: 1.0rem; padding-top: .5rem; padding-bottom: .5rem;`}
      data-target-id={targetID}
      onmouseover={`this.style.backgroundColor='#fde047'`}
      onmouseout={`this.style.backgroundColor='#facc15'`}
      onclick={`(async () => {
        try {
          const zip = prompt('Enter your ZIP code (optional):') || 'unknown';
          const targetID = this.getAttribute('data-target-id');
          await fetch('/.netlify/functions/log-call', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ targetID, zip })
          });
        } catch (err) {
          console.error('Failed to log call:', err);
        }
      })(); return true;`}
    >
      üìû Tap to Call: {formattedPhone}
    </a>
  </div>
</div>

