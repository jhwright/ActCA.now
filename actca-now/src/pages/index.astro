---
// --- IMPORTS ---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// --- DATA FETCHING ---
const allCalls = await getCollection('calls');

// Get unique states from calls collection, sorted
const uniqueStates = Array.from(new Set(allCalls.map(call => call.data.state)))
  .sort();
---

<BaseLayout>
  <main class="relative min-h-screen bg-slate-900">
    <!-- Calls Table -->
    <div class="fixed left-0 right-0 md:left-8 md:right-auto top-24 bottom-8 w-full md:w-80 max-h-[calc(100vh-8rem)] overflow-y-auto px-4 md:px-0">
      <div class="bg-slate-800 border border-yellow-400 rounded-lg overflow-hidden">
        <table class="w-full text-sm font-medium text-yellow-400" id="calls-table">
          <thead class="bg-slate-900 border-b border-yellow-400">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-yellow-400 uppercase tracking-wider w-16">State</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-yellow-400 uppercase tracking-wider">Title</th>
            </tr>
          </thead>
          <tbody>
            {allCalls.map((call) => {
              const callTitle = call.data.title;
              const callState = call.data.state;

              return (
                <tr
                  data-state={callState}
                  class="call-item border-b border-yellow-400 hover:bg-slate-700 transition-colors last:border-b-0"
                >
                  <td class="px-3 py-3 text-sm font-medium text-yellow-400">
                    {callState}
                  </td>
                  <td class="px-3 py-3">
                    <a
                      href={`/call/${call.id}/`}
                      class="text-base font-bold text-yellow-400 hover:text-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:text-yellow-300 block"
                    >
                      {callTitle}
                    </a>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  (() => {
    const STORAGE_KEY = 'actup:state';
    const STATE_FILTER_ID = 'state-filter';
    const CALL_ITEMS_SELECTOR = '.call-item';

    // Initialize function that waits for elements to be available
    const initialize = () => {
      // Get elements - filter might be in navbar or page
      const stateFilter = document.getElementById(STATE_FILTER_ID);
      const callItems = document.querySelectorAll(CALL_ITEMS_SELECTOR);

      if (!stateFilter) {
        // Retry if filter not found yet (may be in BaseLayout)
        setTimeout(initialize, 50);
        return;
      }
      
      if (callItems.length === 0) {
        // Not on index page, no filtering needed
        return;
      }

      // Filter calls by state
      const filterCalls = (selectedState) => {
        const items = Array.from(callItems);
        const visibleItems = items.filter(item => {
          const itemState = item.getAttribute('data-state');
          return selectedState === 'ALL' || itemState === selectedState;
        });

        items.forEach((item) => {
          const itemState = item.getAttribute('data-state');
          const shouldShow = selectedState === 'ALL' || itemState === selectedState;
          
          if (shouldShow) {
            item.style.display = 'table-row';
            // Ensure border is present unless it's the last visible item
            const visibleIndex = visibleItems.indexOf(item);
            const isLast = visibleIndex === visibleItems.length - 1;
            
            if (isLast) {
              item.classList.remove('border-b');
            } else {
              item.classList.add('border-b');
            }
          } else {
            item.style.display = 'none';
          }
        });
      };

      // Save state to localStorage
      const saveState = (state) => {
        try {
          if (state === 'ALL') {
            localStorage.removeItem(STORAGE_KEY);
          } else {
            localStorage.setItem(STORAGE_KEY, state);
          }
        } catch (e) {
          console.warn('Failed to save state to localStorage:', e);
        }
      };

      // Get state from localStorage
      const getStoredState = () => {
        try {
          return localStorage.getItem(STORAGE_KEY) || 'ALL';
        } catch (e) {
          return 'ALL';
        }
      };

      // Get state from URL query parameter
      const getStateFromURL = () => {
        const params = new URLSearchParams(window.location.search);
        return params.get('state') || null;
      };

      // Handle state filter change
      stateFilter.addEventListener('change', (e) => {
        const selectedState = e.target.value;
        filterCalls(selectedState);
        saveState(selectedState);
        
        // Update URL without page reload
        const url = new URL(window.location);
        if (selectedState === 'ALL') {
          url.searchParams.delete('state');
        } else {
          url.searchParams.set('state', selectedState);
        }
        window.history.replaceState({}, '', url);
      });

      // Initialize: restore state from URL or localStorage
      const initializeState = () => {
        const urlState = getStateFromURL();
        const storedState = getStoredState();
        const initialState = urlState || storedState;
        
        // Always set the dropdown value and filter
        if (initialState && initialState !== 'ALL') {
          // Validate that the state exists in options
          const option = Array.from(stateFilter.options).find(opt => opt.value === initialState);
          if (option) {
            stateFilter.value = initialState;
            filterCalls(initialState);
          } else {
            stateFilter.value = 'ALL';
            filterCalls('ALL');
          }
        } else {
          stateFilter.value = 'ALL';
          filterCalls('ALL');
        }
      };

      // Initialize immediately
      initializeState();
    };

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
  })();
</script>

